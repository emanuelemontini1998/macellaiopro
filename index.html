<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#dc2626">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="MacellaioPro">
    <meta name="mobile-web-app-capable" content="yes">
    <title>MacellaioPro</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            touch-action: manipulation;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            padding-bottom: env(safe-area-inset-bottom);
            padding-top: env(safe-area-inset-top);
            overscroll-behavior: none;
        }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .touch-feedback:active { transform: scale(0.95); transition: transform 0.1s; }
        
        section.page { display: none; animation: fadeIn 0.2s; }
        section.page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.85);
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            z-index: 9999;
            animation: slideDown 0.3s;
        }
        @keyframes slideDown { from { transform: translate(-50%, -100%); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }
        
        .numpad-btn { min-height: 64px; font-size: 1.25rem; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

<div id="toastContainer"></div>

<!-- Main App -->
<div id="mainApp">
    
    <!-- Dashboard -->
    <section id="page-dashboard" class="page active p-4 pb-24">
        <div class="max-w-lg mx-auto">
            <div class="mb-6">
                <h1 class="text-2xl font-bold text-slate-900">Cruscotto</h1>
                <p class="text-sm text-slate-500" id="currentDate"></p>
            </div>
            
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="bg-white rounded-2xl p-4 shadow-sm border touch-feedback" onclick="navigateTo('sales-detail')">
                    <div class="w-10 h-10 bg-green-100 rounded-xl flex items-center justify-center mb-3">
                        <i class="fas fa-euro-sign text-green-600"></i>
                    </div>
                    <p class="text-slate-500 text-xs mb-1">Vendite Oggi</p>
                    <p class="text-2xl font-bold" id="todaySales">€0,00</p>
                </div>
                <div class="bg-white rounded-2xl p-4 shadow-sm border touch-feedback" onclick="navigateTo('orders-detail')">
                    <div class="w-10 h-10 bg-blue-100 rounded-xl flex items-center justify-center mb-3">
                        <i class="fas fa-shopping-bag text-blue-600"></i>
                    </div>
                    <p class="text-slate-500 text-xs mb-1">Ordini Oggi</p>
                    <p class="text-2xl font-bold" id="todayOrders">0</p>
                </div>
                <div class="bg-white rounded-2xl p-4 shadow-sm border touch-feedback" onclick="navigateTo('inventory')">
                    <div class="w-10 h-10 bg-red-100 rounded-xl flex items-center justify-center mb-3">
                        <i class="fas fa-boxes text-red-600"></i>
                    </div>
                    <p class="text-slate-500 text-xs mb-1">Critico</p>
                    <p class="text-2xl font-bold" id="lowStockCount">0</p>
                </div>
                <div class="bg-white rounded-2xl p-4 shadow-sm border touch-feedback" onclick="navigateTo('waste')">
                    <div class="w-10 h-10 bg-amber-100 rounded-xl flex items-center justify-center mb-3">
                        <i class="fas fa-exclamation-triangle text-amber-600"></i>
                    </div>
                    <p class="text-slate-500 text-xs mb-1">Scarti</p>
                    <p class="text-2xl font-bold" id="todayWaste">€0,00</p>
                </div>
            </div>

            <div class="bg-white rounded-2xl p-4 shadow-sm border mb-6">
                <h3 class="font-bold mb-4 text-sm">Andamento Settimanale</h3>
                <div class="h-48"><canvas id="salesChart"></canvas></div>
            </div>
            
            <!-- Quick Actions -->
            <div class="bg-white rounded-2xl p-4 shadow-sm border mb-6">
                <h3 class="font-bold mb-4 text-sm">Azioni Rapide</h3>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="openQuickAdd()" class="p-4 bg-red-50 rounded-xl text-red-600 font-medium touch-feedback">
                        <i class="fas fa-plus mb-2 block text-xl"></i>Nuovo Prodotto
                    </button>
                    <button onclick="navigateTo('pos')" class="p-4 bg-green-50 rounded-xl text-green-600 font-medium touch-feedback">
                        <i class="fas fa-cash-register mb-2 block text-xl"></i>Apri Cassa
                    </button>
                    <button onclick="exportToCSV()" class="p-4 bg-blue-50 rounded-xl text-blue-600 font-medium touch-feedback">
                        <i class="fas fa-file-csv mb-2 block text-xl"></i>Export CSV
                    </button>
                    <button onclick="showMargins()" class="p-4 bg-purple-50 rounded-xl text-purple-600 font-medium touch-feedback">
                        <i class="fas fa-chart-pie mb-2 block text-xl"></i>Margini
                    </button>
                </div>
            </div>

            <!-- Search Products -->
            <div class="bg-white rounded-2xl p-4 shadow-sm border">
                <h3 class="font-bold mb-3 text-sm">Cerca Prodotto</h3>
                <div class="relative">
                    <i class="fas fa-search absolute left-3 top-3 text-slate-400"></i>
                    <input type="text" id="searchInput" placeholder="Nome prodotto..." 
                        class="w-full pl-10 pr-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-red-500"
                        oninput="searchProducts(this.value)">
                </div>
                <div id="searchResults" class="mt-3 space-y-2 max-h-48 overflow-y-auto no-scrollbar"></div>
            </div>
        </div>
    </section>

    <!-- Sales Detail -->
    <section id="page-sales-detail" class="page p-4 pb-24">
        <div class="max-w-lg mx-auto">
            <div class="flex items-center gap-3 mb-6">
                <button onclick="navigateTo('dashboard')" class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h1 class="text-2xl font-bold">Dettaglio Vendite</h1>
            </div>
            
            <div class="bg-white rounded-2xl p-4 shadow-sm border mb-4">
                <div class="flex gap-2 mb-4">
                    <button onclick="filterSales('today')" class="filter-sales active flex-1 py-2 px-3 bg-red-600 text-white rounded-xl text-sm font-medium">Oggi</button>
                    <button onclick="filterSales('week')" class="filter-sales flex-1 py-2 px-3 bg-slate-100 rounded-xl text-sm font-medium">Settimana</button>
                    <button onclick="filterSales('month')" class="filter-sales flex-1 py-2 px-3 bg-slate-100 rounded-xl text-sm font-medium">Mese</button>
                </div>
                <div class="text-center py-2 bg-slate-50 rounded-xl mb-4">
                    <span class="text-sm text-slate-500">Totale: </span>
                    <span class="text-xl font-bold text-green-600" id="salesDetailTotal">€0,00</span>
                </div>
                <div id="salesList" class="space-y-3 max-h-96 overflow-y-auto no-scrollbar"></div>
            </div>
        </div>
    </section>

    <!-- Orders Detail -->
    <section id="page-orders-detail" class="page p-4 pb-24">
        <div class="max-w-lg mx-auto">
            <div class="flex items-center gap-3 mb-6">
                <button onclick="navigateTo('dashboard')" class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h1 class="text-2xl font-bold">Storico Ordini</h1>
            </div>
            
            <div class="bg-white rounded-2xl p-4 shadow-sm border">
                <div id="ordersList" class="space-y-3 max-h-[70vh] overflow-y-auto no-scrollbar"></div>
            </div>
        </div>
    </section>

    <!-- Margins Modal -->
    <div id="marginsModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-sm p-6 max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold">Analisi Margini</h3>
                <button onclick="closeMarginsModal()" class="text-slate-400"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div id="marginsContent"></div>
        </div>
    </div>

    <!-- POS -->
    <section id="page-pos" class="page h-screen flex flex-col bg-slate-50">
        <div class="p-4 bg-white shadow-sm z-20">
            <div class="flex justify-between items-center mb-4">
                <h1 class="text-xl font-bold">Cassa</h1>
                <button onclick="clearCart()" class="text-red-600 text-sm font-medium px-3 py-1 bg-red-50 rounded-full">Svuota</button>
            </div>
            <div class="flex gap-2 overflow-x-auto no-scrollbar pb-2">
                <button onclick="filterPOS('all')" class="filter-btn active px-4 py-2 bg-red-600 text-white rounded-full text-sm font-medium whitespace-nowrap">Tutti</button>
                <button onclick="filterPOS('beef')" class="filter-btn px-4 py-2 bg-slate-100 rounded-full text-sm font-medium whitespace-nowrap">Manzo</button>
                <button onclick="filterPOS('pork')" class="filter-btn px-4 py-2 bg-slate-100 rounded-full text-sm font-medium whitespace-nowrap">Maiale</button>
                <button onclick="filterPOS('poultry')" class="filter-btn px-4 py-2 bg-slate-100 rounded-full text-sm font-medium whitespace-nowrap">Pollame</button>
                <button onclick="filterPOS('processed')" class="filter-btn px-4 py-2 bg-slate-100 rounded-full text-sm font-medium whitespace-nowrap">Lavorati</button>
            </div>
        </div>
        
        <div class="flex-1 overflow-y-auto p-4 pb-96" id="posScrollArea">
            <div id="posGrid" class="grid grid-cols-2 gap-3"></div>
        </div>
        
        <!-- Cart -->
        <div id="cartSheet" class="fixed left-4 right-4 bottom-20 bg-white border shadow-2xl rounded-2xl z-40 transition-all duration-300 max-h-[70vh] flex flex-col">
            <div class="p-4 border-b border-slate-100 cursor-pointer shrink-0" onclick="toggleCart()">
                <div class="flex justify-between items-center">
                    <div>
                        <span class="text-sm text-slate-500">Totale</span>
                        <p class="text-2xl font-bold text-red-600" id="cartTotal">€0,00</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="bg-red-100 text-red-700 text-sm px-2 py-1 rounded-full" id="cartCount">0</span>
                        <i class="fas fa-chevron-up text-slate-400 transition-transform" id="cartChevron"></i>
                    </div>
                </div>
            </div>
            <div class="p-4 overflow-y-auto flex-1 hidden" id="cartItemsContainer">
                <div id="cartItems"></div>
            </div>
            <div class="p-4 border-t bg-white shrink-0 hidden" id="cartFooter">
                <button onclick="checkout()" id="checkoutBtn" disabled class="w-full bg-red-600 disabled:bg-slate-300 text-white py-4 rounded-xl font-bold text-lg disabled:cursor-not-allowed touch-feedback shadow-lg">
                    Completa Vendita
                </button>
            </div>
        </div>
    </section>

    <!-- Inventory -->
    <section id="page-inventory" class="page p-4 pb-24">
        <div class="max-w-lg mx-auto">
            <h1 class="text-2xl font-bold mb-4">Magazzino</h1>
            <div class="grid grid-cols-3 gap-3 mb-6">
                <div class="bg-red-50 border border-red-200 rounded-2xl p-3 text-center">
                    <p class="text-xl font-bold text-red-600" id="criticalStock">0</p>
                    <p class="text-xs text-red-700">Critico</p>
                </div>
                <div class="bg-amber-50 border border-amber-200 rounded-2xl p-3 text-center">
                    <p class="text-xl font-bold text-amber-600" id="expiringSoon">0</p>
                    <p class="text-xs text-amber-700">Scadenza</p>
                </div>
                <div class="bg-green-50 border border-green-200 rounded-2xl p-3 text-center">
                    <p class="text-xl font-bold text-green-600" id="healthyStock">0</p>
                    <p class="text-xs text-green-700">OK</p>
                </div>
            </div>
            <div class="bg-white rounded-2xl shadow-sm border overflow-hidden">
                <div id="inventoryList" class="divide-y divide-slate-100"></div>
            </div>
        </div>
    </section>

    <!-- Products -->
    <section id="page-products" class="page p-4 pb-24">
        <div class="max-w-lg mx-auto">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-2xl font-bold">Prodotti</h1>
            </div>
            <div id="productsList" class="space-y-3"></div>
        </div>
        <button onclick="openProductModal()" class="fixed bottom-24 right-5 w-14 h-14 bg-red-600 text-white rounded-full shadow-lg flex items-center justify-center text-2xl touch-feedback z-40">
            <i class="fas fa-plus"></i>
        </button>
    </section>

    <!-- Waste -->
    <section id="page-waste" class="page p-4 pb-24">
        <div class="max-w-lg mx-auto">
            <h1 class="text-2xl font-bold mb-4">Registro Scarti</h1>
            <div class="bg-white rounded-2xl shadow-sm border overflow-hidden">
                <div id="wasteList" class="divide-y divide-slate-100"></div>
            </div>
        </div>
    </section>

    <!-- Bottom Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 z-50 pb-safe">
        <div class="flex justify-around items-center py-2 pb-4">
            <button onclick="navigateTo('dashboard')" data-page="dashboard" class="nav-item active flex flex-col items-center gap-1 px-4 py-2 text-red-600">
                <i class="fas fa-chart-line text-xl"></i>
                <span class="text-xs">Home</span>
            </button>
            <button onclick="navigateTo('pos')" data-page="pos" class="nav-item flex flex-col items-center gap-1 px-4 py-2 text-slate-400">
                <i class="fas fa-cash-register text-xl"></i>
                <span class="text-xs">Cassa</span>
            </button>
            <button onclick="navigateTo('inventory')" data-page="inventory" class="nav-item flex flex-col items-center gap-1 px-4 py-2 text-slate-400">
                <i class="fas fa-warehouse text-xl"></i>
                <span class="text-xs">Stock</span>
            </button>
            <button onclick="navigateTo('products')" data-page="products" class="nav-item flex flex-col items-center gap-1 px-4 py-2 text-slate-400">
                <i class="fas fa-box-open text-xl"></i>
                <span class="text-xs">Prodotti</span>
            </button>
        </div>
    </nav>
</div>

<!-- Quantity Modal -->
<div id="qtyModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-end justify-center p-0">
    <div class="bg-white rounded-t-3xl w-full max-w-sm p-6">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-lg font-bold">Quantità</h3>
            <button onclick="closeQtyModal()" class="text-slate-400"><i class="fas fa-times text-xl"></i></button>
        </div>
        <div class="text-center mb-6">
            <p class="text-sm text-slate-500 mb-1" id="qtyProductName">Prodotto</p>
            <p class="text-3xl font-bold text-red-600" id="qtyDisplay">1.0</p>
            <p class="text-sm text-slate-400" id="qtyUnit">kg</p>
        </div>
        <div class="grid grid-cols-3 gap-3 mb-4">
            <button onclick="appendQty('1')" class="numpad-btn bg-slate-100 rounded-xl font-semibold touch-feedback">1</button>
            <button onclick="appendQty('2')" class="numpad-btn bg-slate-100 rounded-xl font-semibold touch-feedback">2</button>
            <button onclick="appendQty('3')" class="numpad-btn bg-slate-100 rounded-xl font-semibold touch-feedback">3</button>
            <button onclick="appendQty('4')" class="numpad-btn bg-slate-100 rounded-xl font-semibold touch-feedback">4</button>
            <button onclick="appendQty('5')" class="numpad-btn bg-slate-100 rounded-xl font-semibold touch-feedback">5</button>
            <button onclick="appendQty('6')" class="numpad-btn bg-slate-100 rounded-xl font-semibold touch-feedback">6</button>
            <button onclick="appendQty('7')" class="numpad-btn bg-slate-100 rounded-xl font-semibold touch-feedback">7</button>
            <button onclick="appendQty('8')" class="numpad-btn bg-slate-100 rounded-xl font-semibold touch-feedback">8</button>
            <button onclick="appendQty('9')" class="numpad-btn bg-slate-100 rounded-xl font-semibold touch-feedback">9</button>
            <button onclick="appendQty('.')" class="numpad-btn bg-slate-200 rounded-xl font-semibold touch-feedback">.</button>
            <button onclick="appendQty('0')" class="numpad-btn bg-slate-100 rounded-xl font-semibold touch-feedback">0</button>
            <button onclick="clearQty()" class="numpad-btn bg-amber-100 text-amber-700 rounded-xl font-semibold touch-feedback"><i class="fas fa-backspace"></i></button>
        </div>
        <button onclick="confirmQty()" class="w-full bg-red-600 text-white py-4 rounded-xl font-bold text-lg touch-feedback">Aggiungi</button>
    </div>
</div>

<!-- Product Modal -->
<div id="productModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-end justify-center p-0 overflow-y-auto">
    <div class="bg-white rounded-t-3xl w-full max-w-sm p-6 my-auto">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-lg font-bold">Nuovo Prodotto</h3>
            <button onclick="closeProductModal()" class="text-slate-400"><i class="fas fa-times text-xl"></i></button>
        </div>
        <form id="productForm" class="space-y-4">
            <input type="text" id="prodName" placeholder="Nome prodotto" required class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-red-500">
            <select id="prodCategory" class="w-full px-4 py-3 border border-slate-200 rounded-xl">
                <option value="beef">Manzo</option>
                <option value="pork">Maiale</option>
                <option value="poultry">Pollame</option>
                <option value="lamb">Agnello</option>
                <option value="processed">Lavorati</option>
            </select>
            <div class="grid grid-cols-2 gap-3">
                <input type="number" step="0.01" id="prodPrice" placeholder="Prezzo €" required class="w-full px-4 py-3 border border-slate-200 rounded-xl">
                <input type="number" step="0.01" id="prodCost" placeholder="Costo €" required class="w-full px-4 py-3 border border-slate-200 rounded-xl">
            </div>
            <input type="number" step="0.1" id="prodStock" placeholder="Stock iniziale" required class="w-full px-4 py-3 border border-slate-200 rounded-xl">
            <input type="date" id="prodExpiry" required class="w-full px-4 py-3 border border-slate-200 rounded-xl">
            <div class="flex gap-3 pt-4">
                <button type="button" onclick="closeProductModal()" class="flex-1 px-4 py-3 border border-slate-300 rounded-xl">Annulla</button>
                <button type="submit" class="flex-1 px-4 py-3 bg-red-600 text-white rounded-xl font-medium touch-feedback">Salva</button>
            </div>
        </form>
    </div>
</div>

<script type="module" src="js/app.js"></script>
</body>
</html>
